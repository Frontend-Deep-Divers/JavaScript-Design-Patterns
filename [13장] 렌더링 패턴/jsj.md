# 13장 렌더링 패턴

- 렌더링 패턴

![image.png](13%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%85%E1%85%A6%E1%86%AB%E1%84%83%E1%85%A5%E1%84%85%E1%85%B5%E1%86%BC%20%E1%84%91%E1%85%A2%E1%84%90%E1%85%A5%E1%86%AB%2024df78a2bff180c39b29e2102bcba4ba/image.png)

![image.png](13%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%85%E1%85%A6%E1%86%AB%E1%84%83%E1%85%A5%E1%84%85%E1%85%B5%E1%86%BC%20%E1%84%91%E1%85%A2%E1%84%90%E1%85%A5%E1%86%AB%2024df78a2bff180c39b29e2102bcba4ba/image%201.png)

## 13.1 렌더링 패턴의 중요성

- 뛰어난 사용자 경험을 제공하기 위해서는, 핵심 웹 지표와 같은 사용자 중심 지표를 기준으로 애플리케이션을 최적화해야 한다.
(TTFB, FCP, TTI 등등..)
- 동시에 제품/엔지니어링 팀에게 훌륭한 개발 경험을 제공하기 위해서는 빌드 시간 단축, 쉬운 롤백, 확장 가능한 인프라 등 성공적인 개발을 돕는 다양한 기능을 통해 개발 환경을 최적화 해야 한다.
    - 빠른 빌드 시간
        - 빠른 반복 작업과 배포를 위해 프로젝트는 빠르게 빌드되어야 한다.
    - 낮은 서버 비용
        - 웹 사이트는 서버 실행 시간을 제한하고 최적화하여 비용을 절감해야한다.
    - 동적 콘텐츠
        - 페이지는 동적 콘텐츠를 효율적으로 로드할 수 있어야 한다.
    - 쉬운 롤백
        - 이전 빌드 버전으로 빠르게 되돌리고 배포할 수 있어야 한다.
    - 안정적인 가동 시간
        - 운영 서버를 통해 사용자가 항상 웹사이트에 접속할 수 있어야한다.
    - 확장 가능한 인프라
        - 성능 문제없이 프로젝트를 확장 또는 축소할 수 있어야 한다.

## 13.2 클라이언트 사이드 렌더링(CSR)

- 리액트의 CSR에서는 대부분의 애플리케이션 로직이 클라이언트에서 실행되며, 데이터를 가져오거나 저장하기 위한 API 호출로 서버와 상호작용한다.
- 따라서 거의 모든 UI가 클라이언트에서 생성되며 전체 웹 애플리케이션은 처음 요청시에 모두 로드된다.
- 사용자가 링크를 클릭하여 탐색할 때 페이지 렌더링을 위한 새로운 요청을 서버로 보내지 않고, 대신 클라이언트에서 코드가 실행되어 뷰나 데이터를 갈아끼운다.
- CSR은 페이지 고침없이 탐색을 지원하는 SPA를 구축할 수 있게 하여 뛰어난 사용자 경험을 제공한다. 하지만 페이지의 복잡성이 증가하면 페이지 렌더링에 필요한 자바스크립트 코드의 복잡성과 크기도 증가한다.

## 13.3 서버 사이드 렌더링

- 사용자 요청에 대한 응답으로 렌더링할 페이지 콘텐츠의 전체 HTML을 서버에서 생성한다. 이 콘텐츠에는 데이터 저장소나 외부 API에서 가져온 데이터도 포함될 수 있다.
- HTML을 서버에서 렌더링하고 클라이언트에서 다시 하이드레이션하는데 필요한 자바스크립트를 다시 제공하는 것이 핵심이다.

## 13.4 정적 렌더링

- 전체 HTML을 빌드 시점에 미리 생성하며, 다음 빌드 때까지 변경되지 않는다. 이 정적인 HTML 콘텐츠는 CDN이나 엣지 네트워크에 쉽게 캐싱될 수 있다.
- 일반적인 SSR에 비해 페이지 요청을 처리하고, HTML 콘텐츠를 렌더링하고, 응답하는데 걸리는 시간을 단축할 수 있다.
- 정적 렌더링은 다음과 같은 변형이 있다.
    - 데이터베이스의 동적 데이털르 활용한 리스트 페이지 정적 생성
    - 동적 경로를 사용한 상세 페이지 정적 생성
    - 클라이언트 사이드 데이터 fetching을 통한 정적 렌더링
- 정적 렌더링의 주요 특징
    - HTML은 빌드 시점에 생성된다.
    - CDN이나 Vercel의 엣지 네트워크를 통해 쉽게 캐싱될 수 있다.
    - 순수 정적 렌더링은 요청 기반 데이터가 필요하지 않은 페이지에 가장 적합하다.
    - 클라이언트 사이드 데이터 fetching을 통한 정적 렌더링은 매 페이지 로드 시 새로고침되어야 하고 안정적인 placeholder 컴포넌트에 포함된 데이터가 있는 페이지에 가장 적합하다.
- 점진적 정적 생성 (ISR)
    - 정적 렌더링과 SSR을 결합한 방식으로 특정 정적 페이지만 미리 렌더링하고 동적 페이지는 사용자 요청시에 on-demand 방식으로 렌더링한다.
    - 이렇게 되면 빌드 시간이 단축되며, 특정 시간 간격마다 캐시를 자동으로 무효화하고 페이지를 다시 생성할 수 있다.
    - ISR은 빌드 후 기존 정적 사이트에 점진적으로 업데이트를 적용하기 위해 두 가지 측면에서 작동하게 된다.
        - 새로운 페이지 추가 허용
            - 빌드 후 웹사이트에 새로운 페이지를 추가하기 위해 지연 로딩을 사용한다. 새로운 페이지는 첫 요청 즉시 생성되며, 생성되는 동안 프론트엔드에서 사용자에게 대체 페이지나 로딩 화면을 보여줄 수 있다.
        - 기존 페이지 업데이트
            - 각 페이지에 적절한 타임아웃을 정의하고 시간이 경과할 때마다 페이지가 다시 유효한지 검증한다.
- on-demand ISR
    - 일반 ISR과 달리, 정해진 시간 간격이 아니라 특정 이벤트 발생시에 페이지가 재생성된다.
    - 일반 ISR은 업데이트된 페이지가 해당 페이지에 대한 사용자 요청을 처리한 엣지 네트워크 노드에만 캐시된다. 반면, on-demand ISR은 엣지 네트워크 전체에 페이지를 다시 생성하고 재분배하여 자동으로 최신 버전의 페이지를 볼 수 있다.
    - 불필요한 페이지 재생성과 서버리스 함수 호출을 피할 수 있어 일반 ISR에 비해 운용 비용을 절감할 수 있고, 빠르고 동적인 웹사이트를 운영할 수 있다.
- 상황에 맞는 렌더링
    - 순수 정적 렌더링 → 동적인 데이터가 포함되지 않은 페이지
    - 클라이언트 사이드 데이터 fetching을 통한 정적 렌더링 → 매 페이지 로드 시 데이터가 새로고침되어야 하고 안정적인 placeholder 컴포넌트를 가진 페이지에 적합
    - 점진적 정적 생성(ISR) → 특정 간격 또는 필요에 따라 재생성되어야 하는 페이지에 적합
    - On-demand ISR → 특정 이벤트 발생 시 재생성되어야 하는 페이지에 적합

## 13.5 스트리밍 SSR

- 스트리밍 방식을 통해 애플리케이션을 서버에서 렌더링하면서도 TTI와 FCP를 더욱 단축시킬 수 있다.
- 현재 페이지에 필요한 마크업을 모두 담은 큰 HTML 파일 하나를 생성하는 대신, 작은 청크로 나눠 전송하는 방식
- 리액트에 내장된 renderToNodeStream 함수를 사용하여 애플리케이션을 작은 조각으로 나누어 전송할 수 있다.
- 클라이언트는 데이터를 받는 동시에 UI를 그리기 시작할 수 있으므로, 매우 빠른 초기 로딩 경험을 제공할 수 있다.
- 스트리밍은 네트워크 정체 현상에 효과적인데, 네트워크가 혼잡하여 더 이상 바이트를 전송할 수 없는 경우, 렌더러는 신호를 받아 네트워크가 해소될 때까지 스트리밍을 중단하여 서버가 메모리를 덜 사용하고 I/O가 필요한 상황에 더욱 민첩하게 반응할 수 있다.
- 이를 통해 Node.js 서버는 여러 요청을 동시에 처리할 수 있고 무거운 요청들이 가벼운 요청을 장시간 차단하는 것을 방지한다. 이로 인해 열악한 환경에서도 사이트는 빠른 응답성을 유지할 수 있다.
- 스트리밍을 지원하기 위해 ReactDOMServer에 포함된 API들
    - ReactDOMServer.renderToNodeStream(element)
        - 문자열 대신 ReadableStream 방식을 사용해 HTML을 스트리밍으로 렌더링
    - ReactDOMServer.renderToStaticNodeStream(element)

## 13.6 엣지 SSR

- 렌더링된 HTML을 클라이언트에서 전송하기 전에 엣지에서 수정한다.
- CDN의 모든 지역에서 서버 렌더링을 가능하게 하고, 콜드 부트(함수가 처음 실행될 때 발생하는 지연 시간)을 거의 0에 가깝게 줄여준다.
- 서버리스 함수를 사용하면 전체 페이지를 서버 사이드에서 생성할 수 있다. 엣지 런타임은 HTTP 스트리밍도 지원하기에 준비되는 즉시 문서의 일부를 스트리밍하고 각 컴포넌트를 세밀하게 하이드레이션하여 FCP 시간을 단축한다.

## 13.7 하이브리드 렌더링

- 어떤 상황에서든 최적의 결과를 제공하기 위해 여러 가지 렌더링 방식을 결합함
- 웹 개발 환경이 하이브리드 렌더링으로 변화함에 따라 다양한 프레임워크에서 하이브리드 렌더링을 지원하기 시작했음

## 13.8 점진적 하이드레이션

- 각 노드를 시간에 따라 개별적으로 하이드레이션하여 필요한 최소한의 자바스크립트만 요청하는 방식
- 페이지의 상대적으로 덜 중요한 부분의 하이드레이션을 지연시켜 페이지를 상호작용할 수 있게 만드는 데 필요한 자바스크립트 양을 줄이고 사용자에게 필요한 노드만 하이드레이션할 수 있다.
- 점진적 하이드레이션 구현을 위한 요구사항
    - 모든 컴포넌트에 SSR 사용 가능
    - 개별 컴포넌트 또는 조각 단위로 코드 스플리팅 지원
    - 개발자가 정의한 순서대로 클라이언트 사이드에서 각 조각별 하이드레이션 지원
    - 이미 하이드레이션된 조각에서 사용자 입력 가능 상태 유지
    - 지연된 하이드레이션이 적용되는 조각에 로딩 중임을 표시 가능
- 리액트의 동시성 모드 기능이 도입되면 이런 요구사항들을 모두 충족할 수 있음

## 13.9 아일랜드 아키텍처

- 정적인 HTML 위에 독립적으로 전달될 수 있는 상호작용 아일랜드를 통해 자바스크립트의 전송량을 줄이는 패러다임을 의미함
- 컴포넌트 기반의 아키텍처로, 정적. 동적 아일랜드로 구분된 페이지 뷰를 제안함
- 아일랜드 아키텍처는 정적 콘텐츠로 이뤄진 페이지의 SSR을 지원하는데, 이때 렌더링된 HTML에는 동적 콘텐츠를 위한 자리가 미리 마련되어 있음. 이 자리에 자체적으로 완성된 컴포넌트 위젯이 들어가게 되며, 이 위젯들은 독립적인 애플리케이션처럼 동작하며, 서버에서 렌더링된 결과물과 클라이언트에서 위젯을 활성화하는데 사용될 자바스크립트 코드를 포함함
- 장단점
    - 성능
        - 클라이언트에 전송되는 JS 코드의 양을 줄임. (상호작용이 필요한 컴포넌트에만 스크립트가 전송되기 때문) 이를 통해 JS 크기가 작아지고 페이지 로드 속도는 빨라짐
    - SEO
        - 모든 정적 콘텐츠가 서버에서 렌더링되므로 페이지는 검색 엔진 최적화에 유리함
    - 중요 콘텐츠 우선순위
        - 페이지의 핵심 콘텐츠를 사용자가 즉시 볼 수 있음
    - 접근성
        - 표준 정적 HTML 링크를 사용하여 다른 페이지에 접근하므로 웹사이트의 접근성이 향상됨
    - 컴포넌트 기반
        - 재사용성, 유지 보수 용이성
    - 주의점
        - 아직 초기 단계라 아일랜드 아키텍처를 구현하려면 몇 안되는 프레임워크나 직접 아키텍처를 개발해야 함

## 13.10 리액트 서버 컴포넌트

- 서버에서 실행되도록 설계된 상태를 가지지 않는 리액트 컴포넌트
- 이 컴포넌트들을 통해 클라이언트 사이드 자바스크립트 번들의 크기를 크게 줄일 수 있음
- 서버 컴포넌트에서 데이터를 가져오는 방법으로 async/await을 사용하여 데이터 fetching을 컴포넌트 트리의 필수적인 부분으로 통합하고, 최상위 레벨에서 await을 사용해 서버 사이드 데이터 직렬화를 가능하게 함
- 이를 통해 컴포넌트는 데이터를 정기적으로 가져올 수 있으며, 새로운 데이터가 있을 때 다시 렌더링되는 컴포넌트를 가진 애플리케이션을 서버에서 실행할 수 있어 클라이언트로 전송해야 하는 코드 양을 줄일 수 있음

## 렌더링 패턴 표

![image.png](13%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%85%E1%85%A6%E1%86%AB%E1%84%83%E1%85%A5%E1%84%85%E1%85%B5%E1%86%BC%20%E1%84%91%E1%85%A2%E1%84%90%E1%85%A5%E1%86%AB%2024df78a2bff180c39b29e2102bcba4ba/image%202.png)

![image.png](13%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%85%E1%85%A6%E1%86%AB%E1%84%83%E1%85%A5%E1%84%85%E1%85%B5%E1%86%BC%20%E1%84%91%E1%85%A2%E1%84%90%E1%85%A5%E1%86%AB%2024df78a2bff180c39b29e2102bcba4ba/image%203.png)